#!/usr/bin/env node

var CLI  = require('../node/cli'),
    SSH  = require('ssh-agent'),
    pw   = require('pw'),
    tty  = require('tty'),
    
    path = process.env.VAULT_PATH || '.vault',
    
    key  = process.env.VAULT_KEY ||
           process.env.LOGNAME ||
           process.env.USER;

if (!/^\//.test(path)) path = process.env.HOME + '/' + path;

var cli = new CLI({
  config: {path: path, key: key},
  output: process.stdout,
  tty:    tty.isatty(1),
  
  password: function(callback) {
    process.stderr.write('Passphrase: ');
    pw('*', process.stdin, process.stderr, callback);
  },
  
  sshSign: function(string, callback) {
    var client = new SSH(),
        data   = new Buffer(string);
    
    client.requestIdentities(function(err, keys) {
      var key = keys.filter(function(k) { return k.type === 'ssh-rsa' })[0];
      if (!key) return callback(new Error('No usable key found'));
      
      client.sign(key, data, function(error, signature) {
        callback(err, signature.signature);
      });
    });
  }
});

cli.run(process.argv, function(error) {
  if (error) {
    console.error(error.message);
    process.exit(1);
  }
});

