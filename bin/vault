#!/usr/bin/env node

'use strict';

var CLI    = require('../lib/cli'),
    legacy = require('../lib/legacy'),
    path   = require('path'),
    tty    = require('tty'),

    home = process.env.HOME ||
           process.env.USERPROFILE,

    key  = process.env.VAULT_KEY ||
           process.env.LOGNAME ||
           process.env.USER ||
           process.env.USERNAME,

    vaultPath = process.env.VAULT_PATH || '.vault',
    pathname  = path.resolve(home, vaultPath);


var cli = new CLI({
  config: {path: pathname, key: key},
  stdout: process.stdout,
  stderr: process.stderr,
  tty:    tty.isatty(1),

  confirm:   require('../lib/cli/confirm'),
  password:  require('../lib/cli/password'),
  selectKey: require('../lib/cli/select_key'),
  sign:      require('../lib/cli/sign')
});


legacy.migrateConfig(pathname, key).then(function() {
  return cli.run(process.argv);

}).then(function() {
  process.exit(0);

}, function(error) {
  if (error)
    console.error('[ERROR] ' + (process.env.DEBUG ? error.stack : error.message));

  process.exit(1);
});
