#!/usr/bin/env node

var nopt   = require('nopt'),
    crypto = require('crypto'),
    fs     = require('fs'),
    path   = require('path'),
    tty    = require('tty'),
    Vault  = require('../lib/vault'),
    CONFIG = process.env.HOME + '/.vault',
    
    options = { 'config': Boolean,
                'phrase': String,
                'length': Number,
                'lower':  Boolean,
                'upper':  Boolean,
                'alpha':  Boolean,
                'number': Boolean,
                'space':  Boolean,
                'dash':   Boolean,
                'symbol': Boolean
              },
    
    shorts  = { 'c': '--config',
                'p': '--phrase',
                'l': '--length'
              },
    
    params  = nopt(options, shorts),
    service = params.argv.remain[0];


var AES = {
  KEY: Vault.UUID,
  
  encrypt: function(data) {
    var cipher    = crypto.createCipher('aes256', this.KEY),
        encrypted = cipher.update(data, 'utf8', 'binary');
    
    encrypted += cipher.final('binary');
    return encrypted;
  },
  
  decrypt: function(encrypted) {
    var cipher = crypto.createDecipher('aes256', this.KEY),
        data   = cipher.update(encrypted, 'binary', 'utf8');
    
    data += cipher.final('utf8');
    return data;
  }
};


var Config = {
  edit: function(transform) {
    fs.readFile(CONFIG, function(error, data) {
      
      var config = error ? {services: {}} : JSON.parse(AES.decrypt(data.toString()));
      transform(config);
      
      fs.writeFile(CONFIG, AES.encrypt(JSON.stringify(config, true, 2)), function(error) {
        if (error) console.error('Error writing file: ' + CONFIG);
        process.exit(error ? 1 : 0);
      });
    });
  },
  
  read: function(service) {
    var config = {};
    try {
      var content = fs.readFileSync(CONFIG).toString(),
          data    = JSON.parse(AES.decrypt(content));
      
      Vault.extend(config, data.services[service] || {});
      Vault.extend(config, data, function(value) { return typeof value !== 'object' });
    } catch (e) {}
    
    return config;
  }
};


if (params.config) {
  delete params.config;
  
  Config.edit(function(settings) {
    if (service) {
      settings.services[service] = settings.services[service] || {};
      settings = settings.services[service];
    }
    
    for (var key in params) {
      if (typeof params[key] !== 'object')
        settings[key] = params[key];
    }
  });

} else {
  Vault.extend(params, Config.read(service));
  
  if (params.phrase === undefined) {
    console.error('Passphrase is not defined; pass `-p PHRASE` or run `vault -cp PHRASE`');
    process.exit(1);
  }

  if (service === undefined) {
    console.error('Service is undefined');
    process.exit(1);
  }

  var vault    = new Vault(params),
      password = vault.generate(service);
  
  process.stdout.write(password);
  if (tty.isatty(1)) process.stdout.write('\n');
  process.exit(0);
}

