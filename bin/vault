#!/usr/bin/env node

var nopt   = require('nopt'),
    tty    = require('tty'),
    Vault  = require('../lib/vault'),
    Config = require('../lib/vault/config'),
    
    options = { 'config': Boolean,
                'phrase': String,
                'length': Number,
                'lower':  Boolean,
                'upper':  Boolean,
                'alpha':  Boolean,
                'number': Boolean,
                'space':  Boolean,
                'dash':   Boolean,
                'symbol': Boolean
              },
    
    shorts  = { 'c': '--config',
                'p': '--phrase',
                'l': '--length'
              },
    
    params  = nopt(options, shorts),
    service = params.argv.remain[0];


var die = function(message) {
  console.error(message);
  process.exit(1);
};


if (params.config) {
  delete params.config;
  
  Config.edit(function(settings) {
    if (service) {
      settings.services[service] = settings.services[service] || {};
      settings = settings.services[service];
    }
    
    for (var key in params) {
      if (typeof params[key] !== 'object')
        settings[key] = params[key];
    }
  }, function(error) {
    if (error) console.error('Error writing file: ' + configPath);
    process.exit(error ? 1 : 0);
  });
}
else {
  var serviceConfig = Config.read(service);
  if (!serviceConfig)
    die('Your .vault file is unreadable; please set VAULT_KEY correctly');
  
  Vault.extend(params, serviceConfig);
  
  if (params.phrase === undefined)
    die('Passphrase is not defined; pass `-p PHRASE` or run `vault -cp PHRASE`');

  if (service === undefined)
    die('Service is not defined');

  var vault    = new Vault(params),
      password = vault.generate(service);
  
  process.stdout.write(password);
  if (tty.isatty(1)) process.stdout.write('\n');
  process.exit(0);
}

